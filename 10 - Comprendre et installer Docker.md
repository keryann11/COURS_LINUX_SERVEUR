# **√âtape : Comprendre et installer Docker**

## **Introduction √† Docker**

### **Qu'est-ce que Docker ?**

- **Docker** est une plateforme de conteneurisation qui permet d'empaqueter, distribuer et ex√©cuter des applications dans des **conteneurs**.
- Un **conteneur** est un environnement isol√© et portable qui contient tout ce qui est n√©cessaire pour faire fonctionner une application : code, runtime, outils syst√®me, biblioth√®ques et param√®tres.
- Docker simplifie le d√©ploiement d'applications en garantissant qu'elles fonctionnent de mani√®re identique sur n'importe quel environnement.

### **Pourquoi utiliser Docker ?**

- **Portabilit√©** : "√áa fonctionne sur ma machine" ‚Üí "√áa fonctionne partout"
- **Isolation** : Chaque conteneur est isol√© des autres et du syst√®me h√¥te
- **Efficacit√©** : Utilise moins de ressources que les machines virtuelles traditionnelles
- **Rapidit√©** : D√©marrage quasi instantan√© des conteneurs
- **Standardisation** : M√™me environnement du d√©veloppement √† la production
- **√âvolutivit√©** : Facilite la mise √† l'√©chelle des applications

### **Docker vs Machines Virtuelles**

| **Docker (Conteneurs)** | **Machines Virtuelles** |
|-------------------------|-------------------------|
| Partage le noyau de l'OS h√¥te | Chaque VM a son propre OS complet |
| D√©marrage en secondes | D√©marrage en minutes |
| Consommation m√©moire faible | Consommation m√©moire √©lev√©e |
| Isolation au niveau processus | Isolation mat√©rielle compl√®te |
| Id√©al pour les microservices | Id√©al pour l'isolation compl√®te |

## **Concepts fondamentaux**

### **Images Docker**
- **Template** en lecture seule pour cr√©er des conteneurs
- Construites √† partir d'un **Dockerfile**
- Stock√©es dans des **registres** (Docker Hub, etc.)
- Versionn√©es avec des **tags**

### **Conteneurs**
- **Instance** d'une image Docker en cours d'ex√©cution
- Environnement isol√© avec son propre syst√®me de fichiers
- Peuvent √™tre d√©marr√©s, arr√™t√©s, supprim√©s

### **Volumes**
- Permettent la **persistance des donn√©es** au-del√† du cycle de vie d'un conteneur
- Partag√©s entre conteneurs
- Stock√©s sur le syst√®me h√¥te

### **R√©seaux**
- Permettent la **communication** entre conteneurs
- Isolation r√©seau par d√©faut
- Diff√©rents types : bridge, host, overlay
### **Docker Compose**
- Outil pour d√©finir et g√©rer des **applications multi-conteneurs**
- Configuration via un fichier **YAML**
- Orchestre plusieurs services simultan√©ment

#### **Facilit√©s r√©seau avec Docker Compose**
- **R√©seau automatique** : Tous les services d√©finis dans un m√™me fichier `docker-compose.yml` sont connect√©s √† un r√©seau priv√© commun, cr√©√© automatiquement par Docker Compose.
- **R√©solution de noms simplifi√©e** : Chaque service peut √™tre joint par son **nom de service** comme nom d‚Äôh√¥te (ex : `db`, `web`, etc.), facilitant la communication entre conteneurs sans configuration IP manuelle.
- **Isolation** : Les services ne sont accessibles que depuis ce r√©seau interne, sauf si des ports sont explicitement expos√©s vers l‚Äôext√©rieur.
- **Acc√®s entre services** : Les applications peuvent dialoguer entre elles simplement en utilisant le nom du service cible (ex : une application web peut acc√©der √† sa base de donn√©es via `db:3306`).
- **Personnalisation** : Possibilit√© de d√©finir plusieurs r√©seaux ou de connecter des services √† des r√©seaux externes si besoin.

Exemple d‚Äôacc√®s entre services dans un `docker-compose.yml`¬†:
```yaml
services:
    web:
        image: nginx
    db:
        image: mysql
# Le service 'web' peut acc√©der √† 'db' via le nom d‚Äôh√¥te 'db'
```

---

## **Installation de Docker sur Debian 12**

### **Pr√©requis**

#### **Configuration syst√®me requise**

- **Version Debian** : Debian Bookworm 12 (stable)
- **Architecture** : 64-bit (x86_64/amd64)
- **Privil√®ges** : Acc√®s administrateur (`sudo`)

#### **Consid√©rations sur le pare-feu**

> ‚ö†Ô∏è **ATTENTION - Implications de s√©curit√©**
> 
> - Les ports expos√©s par Docker **contournent** les r√®gles de pare-feu `ufw` ou `firewalld`
> - Docker est compatible uniquement avec `iptables-nft` et `iptables-legacy`
> - Les r√®gles cr√©√©es avec `nft` ne sont **pas support√©es**

### **√âtape 1 : Nettoyage des versions ant√©rieures**

Avant d'installer Docker, il faut supprimer toutes les versions non officielles qui pourraient entrer en conflit.

1. **D√©sinstaller les paquets conflictuels**

   ```bash
   sudo apt remove docker.io docker-doc docker-compose podman-docker containerd runc
   ```

   > üìù **Note** : Il est normal que `apt` indique qu'aucun de ces paquets n'est install√©.

2. **Supprimer les donn√©es existantes (optionnel)**

   Si vous souhaitez un red√©marrage complet :

   ```bash
   sudo rm -rf /var/lib/docker
   sudo rm -rf /var/lib/containerd
   ```

   > ‚ö†Ô∏è **ATTENTION** : Cette action supprime d√©finitivement toutes les images, conteneurs et volumes Docker existants.

### **√âtape 2 : Installation via le d√©p√¥t officiel Docker**

#### **Configuration du d√©p√¥t APT**

1. **Mettre √† jour les paquets et installer les d√©pendances**

   ```bash
   sudo apt update
   sudo apt install ca-certificates curl
   ```

2. **Cr√©er le r√©pertoire pour les cl√©s GPG**

   ```bash
   sudo install -m 0755 -d /etc/apt/keyrings
   ```

3. **T√©l√©charger la cl√© GPG officielle de Docker**

   ```bash
   sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
   sudo chmod a+r /etc/apt/keyrings/docker.asc
   ```

4. **Ajouter le d√©p√¥t Docker aux sources APT**

   ```bash
   echo \
     "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
     $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
     sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
   ```

5. **Mettre √† jour la liste des paquets**

   ```bash
   sudo apt update
   ```

#### **Installation des paquets Docker**

1. **Installer Docker Engine et ses composants**

   ```bash
   sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
   ```

   **Explication des paquets** :
   - `docker-ce` : Moteur Docker Community Edition
   - `docker-ce-cli` : Interface en ligne de commande
   - `containerd.io` : Runtime de conteneurs
   - `docker-buildx-plugin` : Builder avanc√© pour images
   - `docker-compose-plugin` : Outil d'orchestration multi-conteneurs

2. **V√©rifier l'installation**

   ```bash
   sudo docker run hello-world
   ```

   **R√©sultat attendu** :
   ```
   Hello from Docker!
   This message shows that your installation appears to be working correctly.
   [...]
   ```

### **√âtape 3 : Configuration post-installation**

#### **Permettre l'utilisation de Docker sans `sudo`**

Par d√©faut, seul `root` peut ex√©cuter des commandes Docker. Pour permettre √† votre utilisateur de le faire sans `sudo` :

1. **Ajouter l'utilisateur au groupe `docker`**

   ```bash
   sudo usermod -aG docker $USER
   ```

2. **Appliquer les changements de groupe**

   ```bash
   newgrp docker
   ```

   Ou red√©marrez votre session :

   ```bash
   logout
   # Reconnectez-vous
   ```

3. **Tester l'acc√®s sans sudo**

   ```bash
   docker run hello-world
   ```

#### **Configurer le d√©marrage automatique**

1. **Activer le service Docker au d√©marrage**

   ```bash
   sudo systemctl enable docker
   ```

2. **V√©rifier le statut du service**

   ```bash
   sudo systemctl status docker
   ```

   **R√©sultat attendu** :
   ```
   ‚óè docker.service - Docker Application Container Engine
        Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; preset: enabled)
        Active: active (running)
   ```

---

## **V√©rification et premiers tests**

### **Commandes de base pour tester Docker**

1. **Afficher la version de Docker**

   ```bash
   docker --version
   docker compose version
   ```

2. **Afficher les informations syst√®me**

   ```bash
   docker info
   ```

3. **Lister les images disponibles**

   ```bash
   docker images
   ```

4. **Lister les conteneurs en cours d'ex√©cution**

   ```bash
   docker ps
   ```

5. **Lister tous les conteneurs (actifs et arr√™t√©s)**

   ```bash
   docker ps -a
   ```

### **Test d'un conteneur simple**

1. **Ex√©cuter un conteneur Ubuntu interactif**

   ```bash
   docker run -it ubuntu:latest bash
   ```

   - `-i` : Mode interactif
   - `-t` : Alloue un pseudo-TTY
   - `ubuntu:latest` : Image Ubuntu derni√®re version
   - `bash` : Commande √† ex√©cuter

2. **√Ä l'int√©rieur du conteneur Ubuntu**

   ```bash
   # Vous √™tes maintenant dans le conteneur
   cat /etc/os-release
   ls /
   exit  # Pour quitter le conteneur
   ```

3. **Tester un serveur web simple**

   ```bash
   docker run -d -p 8080:80 --name test-nginx nginx:latest
   ```

   - `-d` : Mode d√©tach√© (en arri√®re-plan)
   - `-p 8080:80` : Redirection du port 8080 de l'h√¥te vers le port 80 du conteneur
   - `--name test-nginx` : Nom du conteneur

4. **V√©rifier que le serveur fonctionne**

   ```bash
   curl http://localhost:8080
   ```

   Ou ouvrez un navigateur sur `http://IP_DU_SERVEUR:8080`

5. **Arr√™ter et supprimer le conteneur de test**

   ```bash
   docker stop test-nginx
   docker rm test-nginx
   ```

---

## **Concepts avanc√©s pour Guacamole**

### **Docker Compose : Orchestration multi-conteneurs**

Pour notre bastion Guacamole, nous utiliserons **Docker Compose** qui permet de :

- **D√©finir** plusieurs services dans un seul fichier YAML
- **Orchestrer** le d√©marrage, l'arr√™t et la communication entre conteneurs
- **G√©rer** les volumes et r√©seaux de mani√®re centralis√©e
- **Maintenir** la configuration dans un fichier versionnable

### **Structure type d'un projet Docker Compose**

```
guacamole-bastion/
‚îú‚îÄ‚îÄ docker-compose.yml    # Configuration des services
‚îú‚îÄ‚îÄ initdb.sql           # Script d'initialisation de la base de donn√©es
‚îú‚îÄ‚îÄ db/                  # Volume persistant MySQL
‚îî‚îÄ‚îÄ records/             # Volume des enregistrements de sessions
```

### **Volumes persistants**

Pour Guacamole, nous aurons besoin de :

- **Volume base de donn√©es** : `/var/lib/mysql` pour la persistance des configurations
- **Volume enregistrements** : `/var/lib/guacamole/recordings` pour sauvegarder les sessions

### **R√©seaux Docker**

- Docker Compose cr√©e automatiquement un **r√©seau bridge** pour permettre la communication entre conteneurs
- Les conteneurs peuvent se contacter par leur **nom de service**
- Exemple : le conteneur `guacamole` peut contacter `db` directement

---

## **Commandes Docker utiles pour la maintenance**

### **Gestion des images**

```bash
# Lister les images
docker images

# Supprimer une image
docker rmi <nom_image>

# Nettoyer les images non utilis√©es
docker image prune
```

### **Gestion des conteneurs**

```bash
# Lister les conteneurs actifs
docker ps

# Lister tous les conteneurs
docker ps -a

# Arr√™ter un conteneur
docker stop <nom_conteneur>

# Supprimer un conteneur
docker rm <nom_conteneur>

# Voir les logs d'un conteneur
docker logs <nom_conteneur>

# Acc√©der au shell d'un conteneur
docker exec -it <nom_conteneur> bash
```

### **Gestion avec Docker Compose**

> ‚ö†Ô∏è **Attention : Syntaxe des commandes**
>
> Depuis Docker version 20.10+, la commande officielle est `docker compose ...` (avec un espace).  
> L'ancienne syntaxe `docker-compose ...` (avec un tiret) reste compatible mais est d√©pr√©ci√©e.  
> Pr√©f√©rez la nouvelle syntaxe pour les environnements r√©cents.

```bash
# D√©marrer tous les services
docker compose up -d

# Arr√™ter tous les services
docker compose down

# Voir les logs de tous les services
docker compose logs

# Voir les logs d'un service sp√©cifique
docker compose logs <nom_service>

# Red√©marrer un service
docker compose restart <nom_service>

# Mettre √† jour les images
docker compose pull
docker compose up -d
```

### **Nettoyage du syst√®me**

```bash
# Nettoyer tous les √©l√©ments non utilis√©s
docker system prune

# Nettoyer en incluant les volumes
docker system prune --volumes

# Voir l'utilisation de l'espace disque
docker system df
```

---

## **S√©curit√© et bonnes pratiques**

### **S√©curisation de base**

1. **Ne pas ex√©cuter de conteneurs en tant que root**
   ```bash
   # Dans un Dockerfile
   USER 1000:1000
   ```

2. **Limiter les ressources**
   ```bash
   docker run --memory=512m --cpus=1 <image>
   ```

3. **Utiliser des images officielles et v√©rifi√©es**

   #### **üè∑Ô∏è Pourquoi privil√©gier les images officielles ?**

   **Images officielles** (ex: `nginx`, `mysql`, `ubuntu`) :
   - ‚úÖ **Maintenues par les √©diteurs officiels** ou l'√©quipe Docker
   - ‚úÖ **Audits de s√©curit√© r√©guliers** et correctifs appliqu√©s rapidement
   - ‚úÖ **Documentation compl√®te** et exemples d'utilisation
   - ‚úÖ **Optimisations** pour la conteneurisation
   - ‚úÖ **Mises √† jour fr√©quentes** avec cycle de vie pr√©visible

   **Images v√©rifi√©es** (Docker Verified Publisher) :
   - ‚úÖ **Certification Docker** : validation de l'identit√© de l'√©diteur
   - ‚úÖ **Processus de build transparent** et reproductible
   - ‚úÖ **Analyse de vuln√©rabilit√©s** automatis√©e
   - ‚úÖ **Support commercial** disponible

   #### **‚ö†Ô∏è Risques des images non officielles**

   - üö® **Malware et backdoors** : Code malveillant inject√©
   - üö® **Vuln√©rabilit√©s non corrig√©es** : Failles de s√©curit√© connues
   - üö® **Maintenance incertaine** : Abandon du projet sans pr√©avis
   - üö® **Configuration douteuse** : Pratiques non s√©curis√©es
   - üö® **Absence de documentation** : Comportement impr√©visible

   ```bash
   # ‚úÖ RECOMMAND√â : Images officielles
   docker pull nginx:1.24-alpine        # Version sp√©cifique + distribution l√©g√®re
   docker pull mysql:8.0                # Version majeure stable
   docker pull redis:7-alpine           # Version + optimisation
   
   # ‚ùå √Ä √âVITER : Images non officielles ou suspectes
   docker pull randomuser/nginx-custom   # Provenance inconnue
   docker pull sketchy/mysql-hack        # Nom suspect
   ```

   #### **üè∑Ô∏è Gestion des tags : √©viter `:latest`**

   **Probl√®mes du tag `:latest`** :
   - üö® **Instabilit√©** : Changements non ma√Ætris√©s entre d√©ploiements
   - üö® **Breaking changes** : Nouvelles versions incompatibles
   - üö® **Debugging difficile** : Version utilis√©e non tra√ßable
   - üö® **D√©ploiements non reproductibles** : R√©sultats diff√©rents selon la date

   **Strat√©gies de versioning recommand√©es** :

   ```bash
   # ‚úÖ EXCELLENT : Version compl√®te (recommand√© en production)
   docker pull nginx:1.24.0-alpine
   docker pull mysql:8.0.35
   
   # ‚úÖ BON : Version majeure.mineure (acceptable)
   docker pull nginx:1.24-alpine
   docker pull mysql:8.0
   
   # ‚ö†Ô∏è ACCEPTABLE : Version majeure (d√©veloppement/test)
   docker pull nginx:1-alpine
   docker pull mysql:8
   
   # ‚ùå √Ä √âVITER : Tags flottants
   docker pull nginx:latest             # Version non ma√Ætris√©e
   docker pull nginx:mainline           # Branche de d√©veloppement
   docker pull nginx:edge               # Version exp√©rimentale
   ```

   #### **üîç V√©rification des images avant utilisation**

   1. **V√©rifier la provenance sur Docker Hub**
      ```bash
      # Rechercher l'image officielle
      docker search nginx
      # V√©rifier le statut "OFFICIAL" dans les r√©sultats
      ```

   2. **Analyser les vuln√©rabilit√©s**
      ```bash
      # Docker Scout (outil int√©gr√©)
      docker scout quickview nginx:1.24.0-alpine
      
      # Alternative avec Trivy
      docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy:latest image nginx:1.24.0-alpine
      ```

   3. **Examiner l'historique et les layers**
      ```bash
      # Voir l'historique de construction
      docker history nginx:1.24.0-alpine
      
      # Inspecter la configuration
      docker inspect nginx:1.24.0-alpine
      ```

   4. **V√©rifier la signature (si disponible)**
      ```bash
      # Avec Docker Content Trust activ√©
      export DOCKER_CONTENT_TRUST=1
      docker pull nginx:1.24.0-alpine
      ```

   #### **üìã Exemple pour notre projet Guacamole**

   ```bash
   # ‚úÖ Configuration recommand√©e pour la production
   docker pull guacamole/guacd:1.5.4
   docker pull guacamole/guacamole:1.5.4
   docker pull mysql:8.0.35
   
   # ‚ö†Ô∏è Configuration de d√©veloppement (acceptable pour ce TP)
   docker pull guacamole/guacd:1.5
   docker pull guacamole/guacamole:1.5
   docker pull mysql:8.0
   ```

   #### **üõ†Ô∏è Automatisation des mises √† jour s√©curis√©es**

   1. **Utiliser Dependabot ou Renovate** pour les mises √† jour automatiques
   2. **Tests automatis√©s** avant d√©ploiement de nouvelles versions
   3. **Politique de r√©tention** : garder plusieurs versions pour rollback
   4. **Monitoring** des nouvelles vuln√©rabilit√©s (CVE)

   **Exemple de politique de mise √† jour** :
   ```yaml
   # .github/dependabot.yml
   version: 2
   updates:
     - package-ecosystem: "docker"
       directory: "/"
       schedule:
         interval: "weekly"
       target-branch: "develop"
   ```

### **Surveillance et logs**

1. **Configurer la rotation des logs**
   ```bash
   # Dans /etc/docker/daemon.json
   {
     "log-driver": "json-file",
     "log-opts": {
       "max-size": "10m",
       "max-file": "3"
     }
   }
   ```

2. **Surveiller les ressources**
   ```bash
   docker stats
   ```

### **Mise √† jour et maintenance**

1. **Mise √† jour r√©guli√®re de Docker**
   ```bash
   sudo apt update
   sudo apt upgrade docker-ce docker-ce-cli containerd.io
   ```

2. **Sauvegarde des volumes**
   ```bash
   docker run --rm -v guacamole_db:/data -v $(pwd):/backup ubuntu tar czf /backup/db-backup.tar.gz -C /data .
   ```

---

## **D√©pannage**

### **Probl√®mes courants**

#### **1. Permission refus√©e lors de l'ex√©cution de Docker**

**Erreur** :
```
permission denied while trying to connect to the Docker daemon socket
```

**Solution** :
```bash
sudo usermod -aG docker $USER
newgrp docker
```

#### **2. Conflit de ports**

**Erreur** :
```
bind: address already in use
```

**Solution** :
```bash
# Trouver le processus utilisant le port
sudo netstat -tulpn | grep :8080
# Ou utiliser un autre port
docker run -p 8081:80 nginx
```

#### **3. Espace disque insuffisant**

**Erreur** :
```
no space left on device
```

**Solution** :
```bash
docker system prune -a
docker volume prune
```

#### **4. Conteneur qui ne d√©marre pas**

**Diagnostic** :
```bash
docker logs <nom_conteneur>
docker inspect <nom_conteneur>
```

### **Logs et diagnostic**

1. **Logs du daemon Docker**
   ```bash
   sudo journalctl -u docker.service
   ```

2. **Logs d'un conteneur sp√©cifique**
   ```bash
   docker logs --follow <nom_conteneur>
   ```

3. **Inspection d√©taill√©e**
   ```bash
   docker inspect <nom_conteneur>
   ```

---

## **Prochaines √©tapes**

Une fois Docker install√© et test√©, vous √™tes pr√™t √† :

1. **Comprendre Apache Guacamole** - Architecture et composants
2. **D√©ployer le bastion** - Configuration Docker Compose
3. **Configurer les connexions** - RDP, SSH, VNC
4. **S√©curiser l'acc√®s** - HTTPS et authentification

---

## **Ressources compl√©mentaires**

- [Documentation officielle Docker](https://docs.docker.com/)
- [Docker Compose documentation](https://docs.docker.com/compose/)
- [Meilleures pratiques Dockerfile](https://docs.docker.com/develop/dev-best-practices/)
- [S√©curit√© Docker](https://docs.docker.com/engine/security/)
- [Docker Hub](https://hub.docker.com/) - Registre d'images officielles
